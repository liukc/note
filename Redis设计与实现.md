# Redis设计与实现

## 第一章、内部数据结构

### 1 简单动态字符串

Sds （Simple Dynamic String，简单动态字符串）是Redis 底层所使用的字符串表示，它被用在几乎所有的Redis 模块中

#### 1.1 Sds的用途

Sds 在Redis中的主要用途有两个：

- 实现字符串对象
- 在 Redis 程序内部用作char*类型的替代品

##### 实现字符串对象

Redis是一个键值对数据库，数据库的值可以是字符串、集合、列表等多种类型的对象，而数据库的键则总是字符串对象

对于那些包含字符串值的字符串对象来说，每个字符串对象都包含一个Sds 值。

Note: “包含字符串值的字符串对象”，这种说法初听上去可能会有点奇怪，但是在Redis 中，一个字符串对象除了可以保存字符串值之外，还可以保存long 类型的值，所以为了严谨起见，这里需要强调一下：当字符串对象保存的是字符串时，它包含的才是Sds 值，否则的话，它就是一个long 类型的值。

##### 在 Redis 程序内部用作char*类型的替代品

因为char* 类型的功能单一，抽象层次低，并且不能高效地支持一些Redis 常用的操作（比如追加操作和长度计算操作），所以在Redis 程序内部，绝大部分情况下都会使用Sds 而不是char* 来表示字符串。

在Redis 中，客户端传入服务器的协议内容、aof 缓存、返回给客户端的回复，等等，这些重要的内容都是由都是由Sds 类型来保存的。

#### 1.2 Redis 中的字符串

### 3. 双端链表

Redis 的双端链表是由 `listNode` 和 `list` 两个数据构成，如图所示：

![1565057068558](Redis设计与实现.assets/1565057068558.png)

数据结构：

```c
// listNode 双端链表的节点，主要存储当前节点的值、上一个节点和下一个节点
typedef struct listNode {
    // 前驱节点
    struct listNode *prev;
    
    // 后继节点
    struct listNode *next;
    
    // 值
    void *value;
} listNode;

// list 是双端链表的本身
typedef struct list {
    // 表头指针
    listNode *head;
    
    // 表尾指针
    listNode *tail;
    
    // 节点数量
    unsigned long len;
    
    // 复制函数
    void *(*dup)(void *ptr);
    //释放函数
    void *(*free)(void *ptr);
    //比对函数
    int (*match)(void *ptr, void *key);
}list;
```



## 第六章、整数集合

整数集合是集合键的底层实现之一，当一个集合只包含整数值元素，并且这个集合的元素数量不多时，Redis就会使用整数集合作为集合键的底层实现

### 实现

整数集合是Redis用于保存整数值的集合抽象数据结构，它可以保存类型为int16_t、int32_t或者int64_t的整数值，并且保证集合中不会出现重复元素

```c
// intset
typedef struct intset {
    // 编码方式
    uint32_t encoding;
    // 集合包含的元素数量
    uint32_t length;
    // 保存元素的数组，存储的类型取决于encoding
    int8_t contents[];
}intset;
```

contents 数组是整数集合的底层实现，整数集合的每一个元素都是contents的一个数据项，并按从小到大有序不重复的存储。



## 第七章、压缩列表

压缩列表是列表键和哈希键的底层实现之一。当一个列表键只包含少量列表项，并且每个列表项要么是小整数值，要么是长度比较短的字符串，那么Redis就会使用压缩列表来做列表键的底层实现



## 第八章、对象

基于上述的数据结构，Redis创建了一个对象系统，该系统包含了字符串对象、列表对象、哈希对象、集合对象和有序集合对象这五种类型的对象，每种对象都用到了至少一种上述的数据结构



### 对象类型与编码

